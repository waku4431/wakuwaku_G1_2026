<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>わくわくG1サイト 2026</title>

  <!-- ECharts -->
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>

  <style>
    :root{
      --bg:#0b1020;
      --text:#e9eefc;
      --muted:#9fb0dd;
      --border:rgba(255,255,255,.10);
      --accent:#7aa2ff;
      --danger:#ff6b6b;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", "Hiragino Kaku Gothic ProN", "Yu Gothic", sans-serif;
      background: radial-gradient(1200px 600px at 50% -100px, #1b2a5a 0%, var(--bg) 55%, #070a14 100%);
      color:var(--text);
    }
    header{
      padding:16px 14px 10px;
      max-width:1200px; margin:0 auto;
      display:flex; flex-direction:column; gap:10px;
    }
    h1{margin:0; font-size:20px; letter-spacing:.2px}

    .tabs{display:flex; gap:8px; flex-wrap:wrap;}
    .tabbtn{
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      color: var(--text);
      padding:8px 12px;
      border-radius:12px;
      cursor:pointer;
      font-size:13px;
      white-space:nowrap;
    }
    .tabbtn.active{
      border-color: rgba(122,162,255,.6);
      background: rgba(122,162,255,.12);
    }

    .wrap{max-width:1200px; margin:0 auto; padding:10px 12px 26px;}

    /* 余白を詰めてグラフ領域を大きく */
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--border);
      border-radius:16px;
      padding:8px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      overflow:hidden;
    }

    .form{
      display:grid;
      gap:10px;
      grid-template-columns: 1fr 1fr;
    }
    .form .full{grid-column:1 / -1;}
    label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px;}
    input, select{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.20);
      color:var(--text);
      outline:none;
      font-size:16px;
    }
    input::placeholder{color:rgba(233,238,252,.45);}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    .btn{
      border:1px solid var(--border);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-size:13px;
    }
    .btn.primary{
      border-color: rgba(122,162,255,.6);
      background: rgba(122,162,255,.18);
    }
    .badge{
      border:1px solid var(--border);
      padding:6px 10px;
      border-radius:999px;
      background:rgba(255,255,255,.03);
      color: var(--muted);
      font-size:12px;
    }
    .hidden{display:none !important;}
    .hint{font-size:12px; color:rgba(233,238,252,.65);}

    .grid{
      display:grid; gap:12px;
      grid-template-columns: repeat(12, 1fr);
    }
    .c1{grid-column: span 4;}
    .c2{grid-column: span 4;}
    .c3{grid-column: span 4;}
    .c4{grid-column: span 4;}
    .c5{grid-column: span 4;}
    .c6{grid-column: span 4;}
    .c12{grid-column: span 12;}

    .chart{width:100%; height:320px;}
    .chartTall{width:100%; height:360px;}
    .chartHeat{width:100%; height:520px;}

    @media (max-width: 900px){
      .form{grid-template-columns: 1fr;}
      .c1,.c2,.c3,.c4,.c5,.c6,.c12{grid-column: span 12;}
      .chart{height:295px;}
      .chartTall{height:335px;}
      .chartHeat{height:620px;}
    }

    a.linkcard{
      display:block;
      flex:1;
      min-width: 240px;
      text-decoration:none;
      color: var(--text);
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      border-radius:16px;
      padding:14px;
    }
    a.linkcard:hover{
      background: rgba(255,255,255,.06);
      border-color: rgba(255,255,255,.18);
    }
    .linktitle{font-weight:800; margin-bottom:6px;}
    .linkurl{
      font-size:12px;
      color: rgba(233,238,252,.65);
      word-break: break-all;
    }
  </style>
</head>

<body>
<header>
  <div><h1>わくわくG1サイト 2026</h1></div>
  <div class="tabs">
    <button class="tabbtn active" data-tab="input">入力</button>
    <button class="tabbtn" data-tab="dashboard">ダッシュボード</button>
    <button class="tabbtn" data-tab="history">History</button>
  </div>
</header>

<div class="wrap">
  <!-- INPUT -->
  <section id="tab-input" class="card">
    <div class="row" style="justify-content:space-between; margin-bottom:8px;">
      <div class="hint">送信後も <b>参加者/レース</b> を保持。金額も保持したい場合は右の設定をON。</div>
      <label class="row" style="margin:0; gap:8px;">
        <input id="keepAmount" type="checkbox" style="width:auto; transform:scale(1.1);" />
        <span class="hint">金額も保持</span>
      </label>
    </div>

    <form id="entryForm" class="form">
      <div>
        <label>参加者</label>
        <select id="name" required></select>
      </div>

      <div>
        <label>G1レース名</label>
        <select id="race" required></select>
      </div>

      <div>
        <label>掛け金（円）</label>
        <input id="bet" type="number" inputmode="numeric" min="0" step="100" placeholder="例: 1000" required />
      </div>

      <div>
        <label>回収額（円）</label>
        <input id="pay" type="number" inputmode="numeric" min="0" step="100" placeholder="例: 0" required />
      </div>

      <div class="full row" style="justify-content:space-between;">
        <button class="btn primary" type="submit">送信</button>
        <div class="row">
          <button class="btn" type="button" id="toDash">ダッシュボードへ</button>
        </div>
      </div>
    </form>
  </section>

  <!-- DASHBOARD -->
  <section id="tab-dashboard" class="hidden">
    <div class="row" style="justify-content:space-between; margin: 0 0 10px 0;">
      <span class="badge" id="updated">updated: -</span>
      <div class="row">
        <button class="btn" id="reloadBtn" type="button">再読み込み</button>
        <button class="btn" id="toInput" type="button">入力へ</button>
      </div>
    </div>

    <div class="grid">
      <div class="card c1"><h2 style="margin:0 0 6px; color:var(--muted); font-size:13px;">掛け金合計 [円]</h2><div id="barBet" class="chart"></div></div>
      <div class="card c2"><h2 style="margin:0 0 6px; color:var(--muted); font-size:13px;">収支 [円]</h2><div id="barProfit" class="chart"></div></div>
      <div class="card c3"><h2 style="margin:0 0 6px; color:var(--muted); font-size:13px;">回収率 [%]</h2><div id="barRoi" class="chart"></div></div>

      <div class="card c4"><h2 style="margin:0 0 6px; color:var(--muted); font-size:13px;">累積掛け金 [円]</h2><div id="lineCumBet" class="chartTall"></div></div>
      <div class="card c5"><h2 style="margin:0 0 6px; color:var(--muted); font-size:13px;">累積収支 [円] <span class="hint">0ライン</span></h2><div id="lineCumProfit" class="chartTall"></div></div>
      <div class="card c6"><h2 style="margin:0 0 6px; color:var(--muted); font-size:13px;">累積回収率 [%]</h2><div id="lineCumRoi" class="chartTall"></div></div>

      <div class="card c12">
        <h2 style="margin:0 0 6px; color:var(--muted); font-size:13px;">収支表（ヒートマップ）</h2>
        <div id="heatmapProfit" class="chartHeat"></div>
      </div>
    </div>
  </section>

  <!-- HISTORY -->
  <section id="tab-history" class="hidden">
    <div class="card">
      <h2 style="margin:0 0 10px; color:var(--muted); font-size:13px;">過去の結果</h2>

      <div class="row" style="gap:12px;">
        <a class="linkcard" href="https://waku4431.github.io/wakuwaku_G1/" target="_blank" rel="noopener">
          <div class="linktitle">2025（去年のサイト）</div>
          <div class="linkurl">https://waku4431.github.io/wakuwaku_G1/</div>
        </a>

        <a class="linkcard" href="https://docs.google.com/spreadsheets/d/1V1nxbAoVL6SjKAgII8QPmEYw8A5YI-tZUzYFDhKDx1Y/edit?gid=614154890#gid=614154890" target="_blank" rel="noopener">
          <div class="linktitle">2024（スプレッドシート）</div>
          <div class="linkurl">https://docs.google.com/spreadsheets/d/1V1nxbAoVL6SjKAgII8QPmEYw8A5YI-tZUzYFDhKDx1Y/</div>
        </a>
      </div>

      <div class="hint" style="margin-top:10px;">※リンクは新しいタブで開きます</div>
    </div>
  </section>
</div>

<script>
  // ========= 本番WebアプリURL =========
  const GAS_BASE = "https://script.google.com/macros/s/AKfycbw1jiY51U3elE5tyArrcmDH0nYKtJ3N4zrnHx6TNmzojIVOl4-njJaIC7WUlcgp32sbXA/exec";

  // ========= マスタ =========
  const PARTICIPANTS = ["わくだ","きよもと","せきざわ","たきざわ","粗品"];
  const RACES = [
    "フェブラリーステークス（2月22日）",
    "高松宮記念（3月29日）",
    "大阪杯（4月5日）",
    "桜花賞（4月12日）",
    "皐月賞（4月19日）",
    "天皇賞（春）（5月3日）",
    "NHKマイルカップ（5月10日）",
    "ヴィクトリアマイル（5月17日）",
    "オークス（5月24日）",
    "日本ダービー（5月31日）",
    "安田記念（6月7日）",
    "宝塚記念（6月14日）",
    "スプリンターズステークス（9月27日）",
    "秋華賞（10月18日）",
    "菊花賞（10月25日）",
    "天皇賞（秋）（11月1日）",
    "エリザベス女王杯（11月15日）",
    "マイルチャンピオンシップ（11月22日）",
    "ジャパンカップ（11月29日）",
    "チャンピオンズカップ（12月6日）",
    "阪神ジュベナイルフィリーズ（12月13日）",
    "朝日杯フューチュリティステークス（12月20日）",
    "ホープフルステークス（12月26日）",
    "有馬記念（12月27日）"
  ];

  const isMobile = () => window.innerWidth <= 420;

  // ========= 参加者ごとの色（棒/折れ線/ヒートマップで共通） =========
  const COLOR_MAP = {
    "わくだ":   "#7aa2ff",
    "きよもと": "#ffd166",
    "せきざわ": "#ff6b6b",
    "たきざわ": "#6ee7b7",
    "粗品":     "#a78bfa",
  };
  const getColor = (name) => COLOR_MAP[name] || "#7aa2ff";

  // ========= レース名パース（tooltip用） =========
  function parseRaceLabel(raceLabel){
    const m = String(raceLabel || "").match(/^(.+?)（(.+?)）$/);
    if (!m) return { name: String(raceLabel || ""), date: "" };
    return { name: m[1], date: m[2] }; // date: "2月22日"
  }

  // "2月22日" -> {m:2,d:22} みたいに
  function parseMonthDay(md){
    const m = String(md||"").match(/(\d+)月(\d+)日/);
    if(!m) return null;
    return { m:Number(m[1]), d:Number(m[2]) };
  }

  // 文字ゆれ対策：空白/括弧/ハイフン
  function normalizeRaceKey(s){
    return String(s || "")
      .replace(/\s+/g, "")
      .replace(/（/g, "(").replace(/）/g, ")")
      .replace(/[‐-‒–—―]/g, "-");
  }

  // RACES（配列順）を時系列（G1回数）とする
  const RACE_META = RACES.map((r, idx) => {
    const p = parseRaceLabel(r);
    const md = parseMonthDay(p.date);
    return {
      idx,
      g: idx + 1,
      raw: r,
      key: normalizeRaceKey(r),
      name: p.name,
      date: p.date,
      month: md ? md.m : null,
      day: md ? md.d : null
    };
  });

  const RACE_INDEX = (() => {
    const map = new Map();
    for (const r of RACE_META) map.set(r.key, r.idx);
    return map;
  })();

  const fmtJPY = (v) => new Intl.NumberFormat('ja-JP').format(v ?? 0);
  const fmtPct = (v) => `${Number(v ?? 0).toFixed(2)}%`;

  // ========= 先読みキャッシュ（描画遅い対策） =========
  let cachedAllData = null;
  let cachedAllDataAt = 0;
  let prefetchPromise = null;
  const CACHE_MS = 30 * 1000;

  async function loadData() {
    const url = `${GAS_BASE}?type=all&t=${Date.now()}`;
    const res = await fetch(url, { method:"GET" });
    const json = await res.json();
    if (!json.ok) throw new Error(json.error || "GAS ok=false");
    return json;
  }

  async function getAllDataFast() {
    const now = Date.now();
    if (cachedAllData && (now - cachedAllDataAt) < CACHE_MS) return cachedAllData;

    if (prefetchPromise) {
      const data = await prefetchPromise;
      cachedAllData = data;
      cachedAllDataAt = Date.now();
      prefetchPromise = null;
      return data;
    }

    prefetchPromise = loadData();
    const data = await prefetchPromise;
    cachedAllData = data;
    cachedAllDataAt = Date.now();
    prefetchPromise = null;
    return data;
  }

  function prefetchAllData() {
    if (!prefetchPromise && (!cachedAllData || (Date.now() - cachedAllDataAt) > CACHE_MS)) {
      prefetchPromise = loadData()
        .then(d => {
          cachedAllData = d;
          cachedAllDataAt = Date.now();
          return d;
        })
        .finally(() => { prefetchPromise = null; });
    }
  }

  // ========= 入力保持 =========
  const LS_KEY = "waku_g1_form_state_v1";

  function saveFormState() {
    const keepAmount = document.getElementById("keepAmount").checked;
    const state = {
      keepAmount,
      name: document.getElementById("name").value,
      race: document.getElementById("race").value,
      bet: keepAmount ? document.getElementById("bet").value : "",
      pay: keepAmount ? document.getElementById("pay").value : "",
    };
    localStorage.setItem(LS_KEY, JSON.stringify(state));
  }

  function loadFormState() {
    const raw = localStorage.getItem(LS_KEY);
    if (!raw) return;
    try {
      const s = JSON.parse(raw);
      document.getElementById("keepAmount").checked = !!s.keepAmount;
      if (s.name) document.getElementById("name").value = s.name;
      if (s.race) document.getElementById("race").value = s.race;
      if (s.keepAmount) {
        if (s.bet !== undefined) document.getElementById("bet").value = s.bet;
        if (s.pay !== undefined) document.getElementById("pay").value = s.pay;
      }
    } catch {}
  }

  // ========= タブ切り替え =========
  function setTab(tabName) {
    document.querySelectorAll(".tabbtn").forEach(b => {
      b.classList.toggle("active", b.dataset.tab === tabName);
    });
    document.getElementById("tab-input").classList.toggle("hidden", tabName !== "input");
    document.getElementById("tab-dashboard").classList.toggle("hidden", tabName !== "dashboard");
    document.getElementById("tab-history").classList.toggle("hidden", tabName !== "history");
    localStorage.setItem("waku_g1_active_tab", tabName);
    if (tabName !== "dashboard") prefetchAllData();
  }

  // ========= POST =========
  async function postEntry({name, race, bet, pay}) {
    const body = new URLSearchParams({ name, race, bet: String(bet), pay: String(pay) });
    const res = await fetch(GAS_BASE, {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
      body
    });
    const text = (await res.text()).trim();
    if (!res.ok || !text.startsWith("OK")) throw new Error("POST失敗: " + text);
    return text;
  }

  // ========= レイアウト（余白/フォント最適化） =========
  function getChartLayout() {
    const mobile = isMobile();
    return {
      mobile,
      gridLeft:  mobile ? 36 : 46,
      gridRight: mobile ? 10 : 14,
      gridTopBar: 18,
      gridTopLine: 30,
      gridBottomBar:  mobile ? 32 : 40,
      gridBottomLine: mobile ? 30 : 36,
      fontAxis: mobile ? 9 : 11,
      fontLegend: mobile ? 10 : 12,
      axisMargin: mobile ? 6 : 8,
      rotateBarX: 35
    };
  }

  // ========= 棒グラフ =========
  function makeBar(el, title, participants, values, isPct=false) {
    const chart = echarts.init(document.getElementById(el));
    const L = getChartLayout();

    chart.setOption({
      backgroundColor:'transparent',
      grid:{ left:L.gridLeft, right:L.gridRight, top:L.gridTopBar, bottom:L.gridBottomBar, containLabel:true },
      xAxis:{
        type:'category',
        data:participants,
        axisLabel:{ color:'rgba(233,238,252,.85)', rotate:L.rotateBarX, fontSize:L.fontAxis, margin:L.axisMargin }
      },
      yAxis:{
        type:'value',
        axisLabel:{
          color:'rgba(233,238,252,.65)',
          formatter:(v)=> isPct?`${v}%`:fmtJPY(v),
          fontSize:L.fontAxis,
          margin:L.axisMargin
        },
        splitLine:{ lineStyle:{ color:'rgba(255,255,255,.08)' } }
      },
      tooltip:{
        trigger:'axis',
        axisPointer:{ type:'shadow' },
        formatter:(ps)=> {
          const p=ps[0], v=Number(p.value??0);
          return `${p.name}<br>${title}: <b>${isPct?fmtPct(v):"¥"+fmtJPY(v)}</b>`;
        }
      },
      series:[{
        type:'bar',
        data:values,
        barMaxWidth:42,
        itemStyle:{
          color:(params)=>getColor(params.name),
          borderRadius:[10,10,0,0]
        },
        label:{
          show:true,
          position:'insideTop',
          color:'rgba(233,238,252,.95)',
          fontSize: L.mobile ? 11 : 12,
          formatter:(p)=> {
            const v=Number(p.value??0);
            return isPct?`${v.toFixed(0)}%`:`¥${fmtJPY(v)}`;
          }
        }
      }]
    });
    return chart;
  }

  // ========= 折れ線（直線 / 横軸=レース回数 / 偶数表示） =========
  function makeLines(el, block, isPct=false, showZero=false) {
    const chart = echarts.init(document.getElementById(el));
    const L = getChartLayout();

    const dates = block?.dates ?? [];
    const xLabels = dates.map((_, i) => String(i + 1)); // 1..N

    const legends = block?.series ? Object.keys(block.series) : [];
    const series = legends.map(name => ({
      name,
      type:'line',
      data:block.series[name],
      smooth:false,
      showSymbol:false,
      lineStyle:{ width:2, color:getColor(name) },
      emphasis:{ focus:'series' }
    }));

    const opt = {
      backgroundColor:'transparent',
      legend:{
        data:legends,
        top:0,
        left:0,
        itemWidth:14,
        itemHeight:8,
        textStyle:{ color:'rgba(233,238,252,.75)', fontSize:L.fontLegend }
      },
      grid:{ left:L.gridLeft, right:L.gridRight, top:L.gridTopLine, bottom:L.gridBottomLine, containLabel:true },
      xAxis:{
        type:'category',
        data:xLabels,
        boundaryGap:false,
        axisTick:{ alignWithLabel:true },
        axisLabel:{
          color:'rgba(233,238,252,.75)',
          fontSize:L.fontAxis,
          margin:6,
          interval: 0,
          formatter: (val) => {
            const n = Number(val);
            const last = xLabels.length;
            if (n === 1 || n === last) return String(n);
            return (n % 2 === 0) ? String(n) : "";
          }
        },
        name: "レース回数",
        nameLocation: "middle",
        nameGap: L.mobile ? 20 : 24,
        nameTextStyle:{
          color:'rgba(233,238,252,.65)',
          fontSize: L.mobile ? 10 : 12
        }
      },
      yAxis:{
        type:'value',
        axisLabel:{
          color:'rgba(233,238,252,.65)',
          formatter:(v)=> isPct?`${v}%`:fmtJPY(v),
          fontSize:L.fontAxis,
          margin:L.axisMargin
        },
        splitLine:{ lineStyle:{ color:'rgba(255,255,255,.08)' } }
      },
      tooltip:{
        trigger:'axis',
        formatter:(params)=> {
          const idx = Math.max(0, Number(params[0].axisValue) - 1);
          const dateLabel = dates[idx] ?? "";
          const raceName = dateLabel ? (parseRaceLabel(RACES[idx]).name || "") : "";
          const head = raceName ? `G${idx + 1}　${raceName}（${dateLabel}）` : `G${idx + 1}（${dateLabel}）`;

          const lines = params.map(p=>{
            const v=Number(p.value??0);
            return `${p.marker} ${p.seriesName}: <b>${isPct?fmtPct(v):"¥"+fmtJPY(v)}</b>`;
          }).join("<br>");

          return `${head}<br>${lines}`;
        }
      },
      series
    };

    if (showZero) {
      opt.series.forEach(s => s.markLine = {
        symbol:'none',
        lineStyle:{ type:'dashed', opacity:.5 },
        data:[{ yAxis:0 }]
      });
    }

    chart.setOption(opt);
    return chart;
  }

  // ========= ヒートマップ（参加者×時系列） =========
  function buildProfitMatrix(entries){
    const participants = PARTICIPANTS.slice();
    const mat = participants.map(() => Array(RACES.length).fill(0)); // 全レース（天皇賞春含む）を必ず持つ

    const rows = Array.isArray(entries) ? entries : [];

    for (const e of rows) {
      const name = e.name ?? e.participant ?? e.user ?? "";
      const race = e.race ?? e.race_name ?? e.racename ?? "";
      const bet  = Number(e.bet ?? e.bet_amount ?? 0);
      const pay  = Number(e.pay ?? e.pay_amount ?? 0);

      const pIdx = participants.indexOf(name);
      if (pIdx === -1) continue;

      const rIdx = RACE_INDEX.get(normalizeRaceKey(race));
      if (rIdx === undefined) {
        // マッチ漏れがあればここで分かる
        // console.log("race not found:", race);
        continue;
      }

      mat[pIdx][rIdx] += (pay - bet);
    }

    return { participants, mat };
  }

  function makeHeatmap(el, entries){
    const chart = echarts.init(document.getElementById(el));
    const mobile = isMobile();

    const { participants, mat } = buildProfitMatrix(entries);

    const xLabels = RACE_META.map(r => String(r.g)); // 1..24

    const data = [];
    for (let y = 0; y < participants.length; y++){
      for (let x = 0; x < RACE_META.length; x++){
        data.push([x, y, mat[y][x]]);
      }
    }

    const allVals = data.map(d => d[2]);
    const vMin = Math.min(...allVals, 0);
    const vMax = Math.max(...allVals, 0);

    chart.setOption({
      backgroundColor: "transparent",
      grid: {
        left: mobile ? 92 : 120,   // 行ラベル（投票者名）を確実に見せる
        right: mobile ? 10 : 14,
        top: 26,
        bottom: mobile ? 34 : 42,
        containLabel: true
      },
      xAxis: {
        type: "category",
        data: xLabels,
        name: "レース回数",
        nameLocation: "middle",
        nameGap: mobile ? 22 : 26,
        axisLabel: {
          color:'rgba(233,238,252,.75)',
          fontSize: mobile ? 9 : 11,
          interval: 0,
          formatter: (v) => {
            const n = Number(v);
            const last = xLabels.length;
            if (n === 1 || n === last) return String(n);
            return (n % 2 === 0) ? String(n) : "";
          }
        },
        splitArea: { show: false }
      },
      yAxis: {
        type: "category",
        data: participants,
        axisLabel: {
          color:'rgba(233,238,252,.85)',
          fontSize: mobile ? 11 : 12
        }
      },
      visualMap: {
        min: vMin,
        max: vMax,
        calculable: false,
        orient: "horizontal",
        left: "center",
        bottom: 4,
        textStyle: { color: 'rgba(233,238,252,.75)', fontSize: mobile ? 10 : 11 },
        inRange: {
          color: ["#7f1d1d", "#1f2937", "#1d4ed8"] // 赤→濃紺→青
        }
      },
      tooltip: {
        position: "top",
        formatter: (p) => {
          const x = p.data[0];
          const y = p.data[1];
          const val = p.data[2];

          const r = RACE_META[x];
          const person = participants[y];

          const head = `G${r.g}　${r.name}（${r.date}）`;
          const vtxt = (val >= 0) ? `+${fmtJPY(val)}` : `-${fmtJPY(Math.abs(val))}`;
          return `${head}<br>${person}: <b>${vtxt}円</b>`;
        }
      },
      series: [{
        type: "heatmap",
        data,
        label: {
          show: true,
          color: "rgba(233,238,252,.92)",
          fontSize: mobile ? 10 : 11,
          formatter: (p) => {
            const v = Number(p.data[2] || 0);
            if (v === 0) return "0";
            const s = v > 0 ? "+" : "-";
            return s + fmtJPY(Math.abs(v));
          }
        },
        emphasis: {
          itemStyle: {
            borderColor: "rgba(233,238,252,.55)",
            borderWidth: 1
          }
        }
      }]
    });

    return chart;
  }

  // ========= render =========
  let charts = [];
  let resizeBound = false;

  async function renderDashboard() {
    charts.forEach(c => c?.dispose?.());
    charts = [];

    const updated = document.getElementById("updated");
    updated.textContent = "updated: loading...";

    const data = await getAllDataFast();

    const participants = data.summary.map(d => d.participant);
    charts.push(makeBar("barBet", "掛け金合計", participants, data.summary.map(d=>Number(d.bet_total??0)), false));
    charts.push(makeBar("barProfit", "収支", participants, data.summary.map(d=>Number(d.profit_total??0)), false));
    charts.push(makeBar("barRoi", "回収率", participants, data.summary.map(d=>Number(d.roi??0)), true));

    charts.push(makeLines("lineCumBet", data.cumBet, false, false));
    charts.push(makeLines("lineCumProfit", data.cumProfit, false, true));
    charts.push(makeLines("lineCumRoi", data.cumRoi, true, false));

    // ヒートマップ：entries を使う（GASのJSONに entries がある前提）
    // もしキー名が違う場合はここだけ合わせてね（例: data.entries / data.rows / data.data）
    const entries = data.entries || data.rows || data.data || [];
    charts.push(makeHeatmap("heatmapProfit", entries));

    updated.textContent = "updated: " + new Date().toLocaleString("ja-JP");

    if (!resizeBound) {
      resizeBound = true;
      window.addEventListener("resize", () => charts.forEach(c => c?.resize?.()));
    }
  }

  // ========= 初期化 =========
  function fillSelect(id, items) {
    const sel = document.getElementById(id);
    sel.innerHTML = "";
    items.forEach(v => {
      const opt = document.createElement("option");
      opt.value = v;
      opt.textContent = v;
      sel.appendChild(opt);
    });
  }

  fillSelect("name", PARTICIPANTS);
  fillSelect("race", RACES);

  ["name","race","bet","pay","keepAmount"].forEach(id => {
    document.getElementById(id).addEventListener("change", saveFormState);
    document.getElementById(id).addEventListener("input", saveFormState);
  });

  loadFormState();

  // 先読み開始（ダッシュボード切替を速く）
  setTimeout(prefetchAllData, 0);

  const savedTab = localStorage.getItem("waku_g1_active_tab");
  if (savedTab === "dashboard" || savedTab === "history") setTab(savedTab);

  document.querySelectorAll(".tabbtn").forEach(btn => {
    btn.addEventListener("click", async () => {
      const t = btn.dataset.tab;
      setTab(t);
      if (t === "dashboard") {
        try { await renderDashboard(); }
        catch (e) { alert("ダッシュボード取得エラー: " + e.message); }
      }
    });
  });

  document.getElementById("toDash").addEventListener("click", async () => {
    setTab("dashboard");
    try { await renderDashboard(); }
    catch (e) { alert("ダッシュボード取得エラー: " + e.message); }
  });

  document.getElementById("toInput").addEventListener("click", () => setTab("input"));

  document.getElementById("reloadBtn").addEventListener("click", async () => {
    try {
      cachedAllDataAt = 0;
      await renderDashboard();
    } catch (e) {
      alert("再読み込みエラー: " + e.message);
    }
  });

  document.getElementById("entryForm").addEventListener("submit", async (ev) => {
    ev.preventDefault();

    const name = document.getElementById("name").value;
    const race = document.getElementById("race").value;
    const bet  = Number(document.getElementById("bet").value || 0);
    const pay  = Number(document.getElementById("pay").value || 0);

    try {
      await postEntry({ name, race, bet, pay });

      const keepAmount = document.getElementById("keepAmount").checked;
      if (!keepAmount) {
        document.getElementById("bet").value = "";
        document.getElementById("pay").value = "";
      }

      saveFormState();
      prefetchAllData();

    } catch (e) {
      alert(e.message);
    }
  });
</script>
</body>
</html>
